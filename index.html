<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Treino Interativo com IA</title>
    <!-- Carrega Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Estilo customizado para a barra de rolagem */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-track, #1f2937); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--scroll-thumb, #4f46e5); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--scroll-hover, #6366f1); } 
        .ai-button {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s, opacity 0.3s;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 transition-colors duration-300">

    <!-- Cabeçalho -->
    <header class="mb-8 border-b pb-4 transition-colors duration-300" id="mainHeader">
        <div class="flex justify-between items-start">
            <div class="space-y-1">
                <div id="logoPlaceholder" class="flex items-center space-x-3">
                    <i data-lucide="dumbbell" class="w-10 h-10 text-indigo-500"></i> 
                    <h1 class="text-4xl font-extrabold tracking-tight" id="mainTitle">Plano de Treino IA</h1>
                </div>
                <p class="mt-2 text-sm" id="subtitle">Seu guia semanal potencializado por IA.</p>
            </div>
            
            <!-- Botão de Alternar Tema (Claro/Escuro) -->
            <button id="themeToggle" class="p-2 rounded-full hover:bg-opacity-70 transition-colors duration-300">
                <i data-lucide="sun" class="w-6 h-6" id="themeIcon"></i>
            </button>
        </div>
        <div class="mt-4 text-sm" id="userIdContainer">
            ID do Usuário (Firestore): <span id="userIdDisplay" class="font-mono text-xs p-1 rounded">Conectando...</span>
        </div>
    </header>

    <!-- Layout Principal -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Coluna de Navegação (Lateral) -->
        <div id="navigationContainer" class="lg:col-span-1 space-y-2">
            <!-- Os botões de navegação serão gerados aqui pelo JS -->
        </div>

        <!-- Coluna de Conteúdo (Principal) -->
        <main id="contentContainer" class="lg:col-span-3 p-6 rounded-xl transition-colors duration-300">
            <div id="loadingApp" class="flex items-center justify-center p-8">
                <svg class="animate-spin h-8 w-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span class="ml-3 text-lg">Conectando ao Firebase...</span>
            </div>
        </main>
    </div>
    
    <!-- Rodapé -->
    <footer class="mt-12 text-center text-sm border-t pt-4" id="footer">
        Desenvolvido com Vanilla JS, Tailwind CSS e Gemini IA.
    </footer>

    <!-- Script de Inicialização e Lógica (Todo o JS aqui) -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logging do Firestore para diagnóstico
        setLogLevel('Debug');

        // Variáveis Globais de Ambiente (serão fornecidas pelo ambiente Canvas)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Configurações da API Gemini
        // Verifica se há uma chave definida no ambiente externo (por exemplo, injetada por um script de build).
        const externalGeminiKey = typeof __gemini_api_key_override !== 'undefined' ? __gemini_api_key_override : "";
        const GEMINI_API_KEY = externalGeminiKey; 
        const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        // Estado Global da Aplicação
        let db = null;
        let auth = null;
        let currentUserId = null;
        let profile = {};
        let currentPage = 'overview'; // Inicia na Visão Geral
        let authReady = false; // Flag para esperar pela autenticação
        let currentTheme = 'dark'; // Variável de estado para o tema

        // --- Configurações de Páginas e Treino ---
        
        const PAGES = {
            OVERVIEW: 'overview',
            DAY1: 'day1',
            DAY2: 'day2',
            DAY3: 'day3',
            NUTRITION: 'nutrition',
            AI_TOOLS: 'aitools',
            FAQ: 'faq'
        };

        // Templates de Treino Fixo (mapeados para os 3 primeiros dias selecionados)
        const Day1Upper = {
            title: "Treino 1: Parte Superior",
            icon: 'dumbbell',
            color: 'bg-indigo-600',
            exercises: [
                { name: '1. Supino Reto', setsReps: '3 séries de 8-12 repetições', function: 'Principal construtor de massa para o peitoral.' },
                { name: '2. Remada Curvada', setsReps: '3 séries de 8-12 repetições', function: 'Excelente para a densidade e força das costas.' },
                { name: '3. Desenvolvimento de Ombros', setsReps: '3 séries de 10-12 repetições', function: 'Foco principal na porção medial e anterior dos ombros.' },
                { name: '4. Puxada Vertical', setsReps: '3 séries até a falha (ou 8-12 reps)', function: 'Foco na "largura" das costas.' },
                { name: '5. Rosca Direta', setsReps: '3 séries de 10-12 repetições', function: 'Isolamento do bíceps.' },
                { name: '6. Tríceps Pulley', setsReps: '3 séries de 10-12 repetições', function: 'Isolamento do tríceps.' },
            ]
        };
        
        const Day2Cardio = {
            title: "Treino 2: Cardio e Recuperação Ativa",
            icon: 'heart',
            color: 'bg-green-600',
            content: `
                <div class="space-y-4">
                    <h2 class="text-2xl font-extrabold text-indigo-400">Opção 1: Cardio Contínuo (LISS)</h2>
                    <ul class="list-disc list-inside ml-4 space-y-2 text-gray-400">
                        <li><span class="font-semibold text-white">Corrida:</span> 30-45 minutos em intensidade moderada.</li>
                        <li><span class="font-semibold text-white">Bicicleta:</span> 45-60 minutos em terreno variado.</li>
                    </ul>
                    <h2 class="text-2xl font-extrabold text-indigo-400 mt-6">Opção 2: HIIT (Alternativa)</h2>
                    <ul class="list-disc list-inside ml-4 space-y-2 text-gray-400">
                        <li><span class="font-semibold text-white">Exemplo na esteira (20 min):</span> 5 min aquecimento, 8x (1 min forte + 1 min caminhada), 4 min desaquecimento.</li>
                    </ul>
                </div>
            `
        };

        const Day3Lower = {
            title: "Treino 3: Parte Inferior",
            icon: 'dumbbell',
            color: 'bg-red-600',
            exercises: [
                { name: '1. Agachamento Livre', setsReps: '3 séries de 8-12 repetições', function: 'O principal exercício para pernas, trabalhando quadríceps, glúteos e posteriores.' },
                { name: '2. Levantamento Terra Romeno', setsReps: '3 séries de 8-12 repetições', function: 'Foca na cadeia posterior (posteriores e glúteos).' },
                { name: '3. Elevação Pélvica (Hip Thrust)', setsReps: '3 séries de 10-15 repetições', function: 'Melhor exercício para isolar e construir os glúteos.' },
                { name: '4. Leg Press', setsReps: '3 séries de 10-12 repetições', function: 'Permite adicionar volume para o quadríceps.' },
                { name: '5. Cadeira Extensora', setsReps: '3 séries de 10-12 repetições', function: 'Isola completamente o quadríceps.' },
                { name: '6. Mesa Flexora', setsReps: '3 séries de 10-12 repetições', function: 'Isola os posteriores de coxa (isquiotibiais).' },
            ]
        };

        // Dados fixos para o Gráfico de Foco Muscular (plano 3 dias fixo)
        const MUSCLE_FOCUS_DATA = {
            'Peito': 25,
            'Costas': 25,
            'Quadríceps': 20,
            'Glúteos/Post.': 15,
            'Ombros': 10,
            'Braços/Outros': 5
        };
        
        // --- Funções de Utilitário e Tema ---
        
        const getThemeColorClass = (element, state) => {
            const dark = currentTheme === 'dark';

            switch(element) {
                case 'header':
                    return dark ? 'border-gray-700' : 'border-gray-300';
                case 'header-title':
                    return dark ? 'text-indigo-400' : 'text-indigo-700';
                case 'header-subtitle':
                    return dark ? 'text-gray-400' : 'text-gray-600';
                case 'footer':
                    return dark ? 'text-gray-500 border-gray-800' : 'text-gray-500 border-gray-300';
                case 'card-bg':
                    return dark ? 'bg-gray-800 shadow-xl' : 'bg-white shadow-md border border-gray-200';
                case 'nav-bg':
                    if (state === 'active') return 'bg-indigo-600 text-white shadow-lg';
                    if (state === 'disabled') return dark ? 'bg-gray-700/50 text-gray-500 opacity-50 cursor-not-allowed' : 'bg-gray-200/50 text-gray-400 opacity-50 cursor-not-allowed';
                    return dark ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
                case 'text-primary':
                    return dark ? 'text-white' : 'text-gray-900';
                case 'text-secondary':
                    return dark ? 'text-gray-400' : 'text-gray-600';
                case 'input-bg':
                    return dark ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-500' : 'bg-gray-100 border-gray-300 text-gray-900 placeholder-gray-600';
                case 'main-bg':
                    return dark ? 'bg-gray-900/50 shadow-inner shadow-gray-800' : 'bg-gray-50 shadow-inner shadow-gray-300';
                case 'code-bg':
                    return dark ? 'bg-gray-700/50' : 'bg-gray-100/50';
                default:
                    return '';
            }
        };

        const applyTheme = (theme) => {
            currentTheme = theme;
            const body = document.body;
            const isDark = theme === 'dark';
            
            // 1. Atualiza as classes do Body
            body.className = `min-h-screen p-4 md:p-8 transition-colors duration-300 ${isDark ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-900'}`;

            // 2. Atualiza o ícone do botão
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            }

            // 3. Atualiza estilos globais (footer, header)
            document.getElementById('mainHeader').className = `mb-8 border-b pb-4 transition-colors duration-300 ${getThemeColorClass('header')}`;
            document.getElementById('footer').className = `mt-12 text-center text-sm border-t pt-4 ${getThemeColorClass('footer')}`;
            document.getElementById('mainTitle').className = `text-4xl font-extrabold tracking-tight ${getThemeColorClass('header-title')}`;
            document.getElementById('subtitle').className = `mt-2 text-sm ${getThemeColorClass('header-subtitle')}`;
            
            // 4. Persiste a escolha
            localStorage.setItem('app-theme', theme);
            
            // 5. Rerenderiza o conteúdo para aplicar as classes
            if (authReady) {
                 renderApp();
            } else {
                 recreateLucideIcons({ attrs: { class: 'w-6 h-6' } });
            }
        };

        const toggleTheme = () => {
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        };
        
        /**
         * Verifica se o perfil básico está salvo e se dias de treino foram selecionados.
         */
        const isAppUnlocked = () => profile && profile.name && profile.name.trim() !== '' && (profile.trainingDays && profile.trainingDays.length > 0);

        /**
         * Renderiza o indicador de loading.
         * @param {string} message 
         * @returns {string} HTML do indicador.
         */
        const LoadingIndicator = (message = "A IA está trabalhando...") => `
            <div class="flex items-center justify-center p-4 ${getThemeColorClass('code-bg')} rounded-lg animate-pulse">
                <svg class="w-5 h-5 mr-2 text-indigo-400 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span class="text-white text-sm">${message}</span>
            </div>
        `;

        /**
         * Renderiza o box de resultado da IA.
         */
        const AiResultBox = (title, content) => `
            <div class="mt-4 p-5 ${getThemeColorClass('card-bg')} rounded-xl shadow-lg border border-indigo-600">
                <h3 class="text-xl font-bold text-indigo-400 mb-3 flex items-center">
                    <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                    ${title}
                </h3>
                <div class="${getThemeColorClass('text-secondary')} whitespace-pre-wrap">
                    ${content}
                </div>
            </div>
        `;

        /**
         * Função genérica para chamar a API Gemini com retentativas. (funções fetchWithRetry, fetchTTS, base64ToArrayBuffer, writeString, pcmToWav, playAudio mantidas)
         * ... (Para simplificar, as funções de API foram mantidas no script original)
         */
        const fetchWithRetry = async (userQuery, systemPrompt, schema = null, maxRetries = 3) => {
            let lastError = null;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }],
                ...(schema && {
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                })
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API response error: ${response.status} - ${response.statusText}. Body: ${errorBody}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        if (schema) {
                            try {
                                const parsedJson = JSON.parse(text);
                                return { text, json: parsedJson };
                            } catch (e) {
                                console.error("Erro ao analisar JSON. Tentando novamente...", e);
                                lastError = new Error("Resposta não JSON apesar do esquema solicitado.");
                            }
                        } else {
                            return { text };
                        }
                    } else {
                        throw new Error("Resposta da IA vazia ou malformada.");
                    }
                } catch (error) {
                    console.error(`Tentativa ${i + 1} falhou:`, error);
                    lastError = error;
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            throw new Error(`Falha após ${maxRetries} tentativas: ${lastError?.message || 'Erro desconhecido.'}`);
        };

        const recreateLucideIcons = (sizeAttrs) => {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons(sizeAttrs);
            }
        };

        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };
        
        const pcmToWav = (pcm16, sampleRate) => {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);

            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            
            // RIFF identifier 'RIFF'
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * 2, true);
            
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }
            
            return new Blob([view], { type: 'audio/wav' });
        };

        const playAudio = (audioUrl) => {
            const audio = new Audio(audioUrl);
            audio.play().catch(e => console.error("Erro ao reproduzir áudio:", e));
        };

        const fetchTTS = async (text, button, originalText) => {
            const VOICE = "Kore"; 
            
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: VOICE } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const resetButtonStyle = (label, icon, colorClass) => {
                button.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-2"></i> ${label}`;
                button.disabled = false;
                button.classList.remove('bg-green-700', 'bg-red-600');
                if (colorClass) button.classList.add(colorClass);
                recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
            };

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`TTS API Error: ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const match = mimeType.match(/rate=(\d+)/);
                    const sampleRate = match ? parseInt(match[1], 10) : 16000;

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    playAudio(audioUrl);
                    
                    button.innerHTML = '<i data-lucide="volume-2" class="w-5 h-5 mr-2"></i> Reproduzindo...';
                    recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
                    
                    setTimeout(() => {
                        resetButtonStyle('Ouvir Dica (Áudio)', 'volume-2', 'bg-green-600');
                    }, 5000); 

                } else {
                    throw new Error("Dados de áudio inválidos ou ausentes na resposta da IA.");
                }

            } catch (error) {
                console.error("Erro no TTS:", error);
                resetButtonStyle('Erro no Áudio', 'volume-x', 'bg-red-600');
                setTimeout(() => {
                    resetButtonStyle('Ouvir Dica (Áudio)', 'volume-2', 'bg-green-600');
                }, 3000);
            }
        };


        // --- Funções de Renderização e Lógica ---

        const handleProfileSave = async (e) => {
            e.preventDefault();
            const form = e.target;
            
            if (!currentUserId || !db) {
                console.error('Aguardando conexão ou autenticação do Firebase para salvar.');
                return;
            }

            // Coleta os dias selecionados
            const selectedDays = Array.from(form.querySelectorAll('input[name="trainingDays"]:checked')).map(cb => cb.value);

            if (selectedDays.length === 0) {
                 // Substituído 'alert' por console.error e tratamento visual ou modal
                 console.error('Por favor, selecione pelo menos um dia para treino.');
                 // Em um ambiente real, você usaria um modal/mensagem de erro na UI aqui.
                 // Para este ambiente, apenas retornamos.
                 return;
            }

            // CORREÇÃO: Acessa os valores dos campos de forma defensiva usando optional chaining (?.),
            // prevenindo o erro de 'reading value of undefined' se o elemento não for encontrado.
            const nameValue = form.name?.value || '';
            const ageValue = form.age?.value || '';
            const genderValue = form.gender?.value || '';
            const emailValue = form.email?.value || '';

            const profileData = {
                name: nameValue,
                age: ageValue ? parseInt(ageValue) : null,
                gender: genderValue,
                email: emailValue,
                trainingDays: selectedDays, // Novo campo
                updatedAt: new Date().toISOString()
            };

            const saveButton = form.querySelector('button[type="submit"]');
            saveButton.innerHTML = LoadingIndicator('Salvando...');
            saveButton.disabled = true;

            try {
                // Caminho Firestore: /artifacts/{appId}/users/{userId}/profile/main
                const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/main`);
                await setDoc(docRef, profileData, { merge: true });
                // O onSnapshot irá atualizar o estado "profile" e chamar renderContent()
                
                saveButton.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Perfil Salvo!';
                saveButton.classList.remove('bg-indigo-600');
                saveButton.classList.add('bg-green-600');
                
                // Força a navegação para Visão Geral após salvar e desbloquear
                currentPage = PAGES.OVERVIEW;

                setTimeout(() => {
                    saveButton.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Salvar Perfil e Iniciar';
                    saveButton.classList.remove('bg-green-600');
                    saveButton.classList.add('bg-indigo-600');
                    saveButton.disabled = false;
                }, 3000);

            } catch (error) {
                console.error("Erro ao salvar o perfil no Firestore:", error);
                saveButton.innerHTML = '<i data-lucide="zap" class="w-5 h-5 mr-2"></i> Erro ao Salvar!';
                saveButton.classList.remove('bg-indigo-600');
                saveButton.classList.add('bg-red-600');
                saveButton.disabled = false;
            }
        };

        const renderProfileForm = () => {
            const dayCodes = ['SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SAB', 'DOM'];
            const dayNamesFull = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
            const selectedDays = profile.trainingDays || [];
            const inputBgClass = getThemeColorClass('input-bg');
            const textSecondary = getThemeColorClass('text-secondary');

            return `
                <form id="profileForm" class="space-y-4 p-6 ${getThemeColorClass('card-bg')} rounded-xl shadow-2xl">
                    <h2 class="text-2xl font-extrabold text-indigo-400 mb-4">Suas Informações e Plano Semanal</h2>
                    <p class="${textSecondary} mb-6">Preencha seus dados e escolha seus dias de treino. (Salvo no Firestore).</p>

                    <label class="block">
                        <span class="text-sm font-medium ${textSecondary}">Nome Completo</span>
                        <input type="text" name="name" value="${profile.name || ''}" class="mt-1 block w-full px-4 py-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}" placeholder="Seu nome" />
                    </label>

                    <div class="grid grid-cols-2 gap-4">
                        <label class="block">
                            <span class="text-sm font-medium ${textSecondary}">Idade</span>
                            <input type="number" name="age" value="${profile.age || ''}" class="mt-1 block w-full px-4 py-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}" placeholder="25" />
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium ${textSecondary}">Sexo</span>
                            <select name="gender" class="mt-1 block w-full px-4 py-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}">
                                <option value="">Selecione</option>
                                <option value="Masculino" ${profile.gender === 'Masculino' ? 'selected' : ''}>Masculino</option>
                                <option value="Feminino" ${profile.gender === 'Feminino' ? 'selected' : ''}>Feminino</option>
                                <option value="Outro" ${profile.gender === 'Outro' ? 'selected' : ''}>Outro</option>
                            </select>
                        </label>
                    </div>

                    <h3 class="text-lg font-semibold ${getThemeColorClass('text-primary')} pt-4">Dias de Treino</h3>
                    <div class="grid grid-cols-4 md:grid-cols-7 gap-2">
                        ${dayCodes.map((code, index) => `
                            <label class="flex flex-col items-center justify-center p-2 rounded-lg cursor-pointer transition-colors duration-200 ${
                                selectedDays.includes(code) 
                                    ? 'bg-indigo-600 text-white shadow-lg' 
                                    : `${currentTheme === 'dark' ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} ${textSecondary}`
                            }">
                                <input 
                                    type="checkbox" 
                                    name="trainingDays" 
                                    value="${code}" 
                                    ${selectedDays.includes(code) ? 'checked' : ''} 
                                    class="hidden"
                                    onchange="this.closest('label').classList.toggle('bg-indigo-600', this.checked); this.closest('label').classList.toggle('text-white', this.checked); this.closest('label').classList.toggle('shadow-lg', this.checked); this.closest('label').classList.toggle('${currentTheme === 'dark' ? 'bg-gray-700' : 'bg-gray-200'}', !this.checked); this.closest('label').classList.toggle('${textSecondary}', !this.checked);"
                                />
                                <span class="font-bold text-sm">${dayNamesFull[index].substring(0, 3)}</span>
                            </label>
                        `).join('')}
                    </div>

                    <button type="submit" class="w-full mt-6 py-3 px-4 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 disabled:bg-indigo-900 disabled:opacity-50 flex items-center justify-center shadow-lg">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                        Salvar Perfil e Iniciar
                    </button>
                </form>
            `;
        };
        
        // --- Geração Dinâmica de Itens de Navegação ---

        const getTrainingNavItems = () => {
            const selectedDays = profile.trainingDays || []; 
            const dayNames = {
                'SEG': 'Segunda', 'TER': 'Terça', 'QUA': 'Quarta', 
                'QUI': 'Quinta', 'SEX': 'Sexta', 'SAB': 'Sábado', 'DOM': 'Domingo'
            };
            
            const templates = [
                { id: PAGES.DAY1, template: Day1Upper, type: 'Superior' },
                { id: PAGES.DAY2, template: Day2Cardio, type: 'Cardio' },
                { id: PAGES.DAY3, template: Day3Lower, type: 'Inferior' },
            ];

            return selectedDays.slice(0, 3).map((dayCode, index) => {
                const templateInfo = templates[index];
                const dayLabel = dayNames[dayCode] || dayCode;
                
                return {
                    id: templateInfo.id,
                    label: `${templateInfo.type} (${dayLabel.substring(0, 3)})`,
                    icon: templateInfo.template.icon,
                    template: templateInfo.template
                };
            });
        };

        const getBaseNavItems = () => [
            { id: PAGES.OVERVIEW, label: 'Visão Geral', icon: 'target' },
            { id: PAGES.NUTRITION, label: 'Nutrição', icon: 'utensils' },
            { id: PAGES.AI_TOOLS, label: 'Ferramentas IA', icon: 'sparkles' },
            { id: PAGES.FAQ, label: 'Assistente IA', icon: 'message-square' },
        ];

        const getNavItems = () => {
            const baseItems = getBaseNavItems();
            const trainingItems = isAppUnlocked() ? getTrainingNavItems() : [];
            
            // Combina itens de navegação, inserindo os treinos após Visão Geral
            const overviewIndex = baseItems.findIndex(item => item.id === PAGES.OVERVIEW);
            if (overviewIndex !== -1) {
                baseItems.splice(overviewIndex + 1, 0, ...trainingItems);
            }
            return baseItems;
        };


        const renderNavigation = () => {
            const container = document.getElementById('navigationContainer');
            const navItems = getNavItems();
            const unlocked = isAppUnlocked();

            container.innerHTML = navItems.map(item => {
                const isOverview = item.id === PAGES.OVERVIEW;
                // Os botões são desabilitados se não for a Visão Geral E se o app não estiver desbloqueado
                const isDisabled = !isOverview && !unlocked; 
                
                const baseClass = `w-full text-left p-3 rounded-lg font-semibold transition duration-200 flex items-center nav-button`;
                
                const themeState = isDisabled ? 'disabled' : (currentPage === item.id ? 'active' : 'inactive');
                const themeClass = getThemeColorClass('nav-bg', themeState);

                return `
                    <button
                        data-page="${item.id}"
                        ${isDisabled ? 'disabled' : ''}
                        class="${baseClass} ${themeClass}"
                    >
                        <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                        <span class="ml-3">${item.label}</span>
                    </button>
                `;
            }).join('');

            // Adiciona listeners para navegação (apenas para botões não desabilitados)
            container.querySelectorAll('.nav-button:not([disabled])').forEach(button => {
                button.addEventListener('click', () => {
                    currentPage = button.getAttribute('data-page');
                    renderContent();
                });
            });
            recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
        };
        
        // --- Gráfico de Foco Muscular ---
        const renderMuscleFocusChart = () => {
            const isDark = currentTheme === 'dark';
            const chartColor = 'bg-indigo-600';
            const bgColor = isDark ? 'bg-gray-700' : 'bg-gray-200';
            const textColor = isDark ? 'text-gray-300' : 'text-gray-700';

            return `
                <div class="space-y-4">
                    <h2 class="text-2xl font-extrabold text-indigo-400">Foco Muscular do Plano (3 Dias)</h2>
                    <p class="${textColor} text-sm">Distribuição de ênfase (porcentagem de volume/esforço) com base no seu plano Superior/Cardio/Inferior.</p>
                    <div class="grid gap-2">
                        ${Object.entries(MUSCLE_FOCUS_DATA).map(([muscle, percentage]) => `
                            <div class="flex items-center space-x-3">
                                <span class="w-24 text-sm font-medium ${textColor}">${muscle}</span>
                                <div class="flex-grow ${bgColor} rounded-full h-4">
                                    <div 
                                        class="${chartColor} h-4 rounded-full transition-all duration-700 ease-out" 
                                        style="width: ${percentage}%;"
                                    ></div>
                                </div>
                                <span class="text-sm font-bold ${textColor} w-8 text-right">${percentage}%</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        // --- Funções de Conteúdo de Página ---
        
        const renderDayTemplate = (dayData) => {
            let contentHtml = '';
            
            // Verifica se é o template de Cardio (Day2Cardio)
            if (dayData.content) {
                contentHtml = dayData.content;
            } else {
                // É um template de treino de força (Day1Upper, Day3Lower)
                contentHtml = dayData.exercises.map(renderExerciseCard).join('');
            }

            let html = `
                <div class="space-y-10">
                    <h1 class="text-4xl font-extrabold text-indigo-500 border-b border-indigo-500 pb-3">${dayData.title}</h1>
                    <div id="dailyTipContainer" class="p-6 ${getThemeColorClass('card-bg')} rounded-xl shadow-2xl space-y-4">
                        <h2 class="text-2xl font-extrabold text-indigo-400 flex items-center">
                            <i data-lucide="sparkles" class="w-6 h-6 mr-2 text-indigo-400"></i>
                            Dica do Dia com IA
                        </h2>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button data-action="daily-tip-text" id="btnGenerateTip" class="flex-1 py-3 px-6 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 ai-button ai-delegated-button">
                                <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Gerar Dica com IA (Texto)
                            </button>
                            <button data-action="read-tip-tts" id="btnReadTip" class="flex-1 py-3 px-6 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 transition duration-300 ai-button ai-delegated-button">
                                <i data-lucide="volume-2" class="w-5 h-5 mr-2"></i> Ouvir Dica (Áudio)
                            </button>
                        </div>
                        <div id="dailyTipResult" data-last-tip-text=""></div>
                    </div>
                    ${contentHtml}
                </div>
            `;
            
            return html;
        };

        const renderExerciseCard = (exercise) => {
            const safeName = exercise.name.replace(/[^a-zA-Z0-9]/g, '-');
            const buttons = [
                { label: 'Ver Explicação', type: 'explanation' },
                { label: 'Sugerir Variação', type: 'variation' },
                { label: 'Descrever Forma', type: 'form' },
            ];

            return `
                <div class="p-6 ${getThemeColorClass('card-bg')} rounded-xl shadow-2xl space-y-3 border-l-4 border-indigo-500 exercise-card">
                    <h3 class="text-xl font-bold ${getThemeColorClass('text-primary')}">${exercise.name}</h3>
                    <p class="text-indigo-400 font-semibold">${exercise.setsReps}</p>
                    <p class="${getThemeColorClass('text-secondary')}">${exercise.function}</p>

                    <div class="flex flex-wrap gap-3 pt-2">
                        ${buttons.map((btn) => `
                            <button
                                data-action="${btn.type}"
                                data-name="${exercise.name}"
                                id="btn-${safeName}-${btn.type}"
                                class="flex-1 min-w-[150px] py-2 px-3 rounded-lg ${currentTheme === 'dark' ? 'bg-gray-700 text-indigo-300 hover:bg-gray-600' : 'bg-gray-200 text-indigo-700 hover:bg-gray-300'} text-sm font-medium transition duration-200 ai-button ai-delegated-button"
                            >
                                <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                                ${btn.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const renderPage = (pageId) => {
            const cardBgClass = getThemeColorClass('card-bg');
            const textSecondary = getThemeColorClass('text-secondary');
            
            const navItems = getNavItems();
            const trainingItem = navItems.find(item => item.id === pageId && item.template);
            
            // Lógica para renderizar páginas dinâmicas (Dia 1, Dia 2, Dia 3)
            if (trainingItem) {
                return renderDayTemplate(trainingItem.template);
            }

            switch (pageId) {
                case PAGES.OVERVIEW:
                    return `
                        <div class="space-y-10">
                            ${renderProfileForm()}
                            <div class="p-6 ${cardBgClass} rounded-xl shadow-2xl space-y-4">
                                ${renderMuscleFocusChart()}
                            </div>
                        </div>
                    `;
                case PAGES.NUTRITION:
                    return renderNutritionPage();
                case PAGES.AI_TOOLS:
                    return renderAiToolsPage();
                case PAGES.FAQ:
                    return renderFaqPage();
                default:
                    return `<div>Página não encontrada.</div>`;
            }
        };


        // --- DELEGAÇÃO DE EVENTOS PARA BOTÕES DE IA (mantido) ---
        // ... (handleDelegatedClick and all handler functions for AI tools are maintained from the original script)

        /**
         * Centralized handler for all exercise and daily tip buttons (Performance Optimization)
         */
        const handleDelegatedClick = async (e) => {
            const button = e.target.closest('.ai-delegated-button');
            if (!button || button.disabled) return;

            const action = button.getAttribute('data-action');
            const name = button.getAttribute('data-name');
            const originalText = button.innerHTML;
            
            if (!action) return;

            // Variável para conter o container pai da ação
            const actionContainer = button.closest('.space-y-4, .space-y-10');
            
            // --- Lógica da Dica do Dia ---
            if (action === 'daily-tip-text' || action === 'read-tip-tts') {
                const resultContainer = document.getElementById('dailyTipResult');
                const lastTipText = resultContainer.dataset.lastTipText;
                
                if (action === 'read-tip-tts') {
                    if (lastTipText) {
                         button.innerHTML = LoadingIndicator('Gerando Áudio...');
                         button.disabled = true;
                         fetchTTS(lastTipText, button, originalText);
                    } else {
                        resultContainer.innerHTML = AiResultBox("Erro", "Primeiro, gere a Dica do Dia (Texto) para que a IA possa lê-la.");
                        recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
                    }
                    return; 
                }

                // Lógica para gerar o texto da dica (daily-tip-text)
                button.innerHTML = LoadingIndicator('Gerando Dica...');
                button.disabled = true;
                resultContainer.innerHTML = '';

                const dayTitle = button.closest('.space-y-10').querySelector('h1').textContent;
                const systemPrompt = `Você é um personal trainer. Crie uma "Dica do Dia" motivacional e acionável, focada em ${dayTitle.includes('Superior') ? 'treino de força e técnica' : dayTitle.includes('Cardio') ? 'resistência e consistência' : 'força e mobilidade'}.`;
                const userQuery = `Gere uma dica de treino personalizada para ${profile.name || 'um atleta'}.`;

                try {
                    const apiResult = await fetchWithRetry(userQuery, systemPrompt);
                    resultContainer.innerHTML = AiResultBox("Dica do Dia IA", apiResult.text);
                    // Salva o texto gerado para ser lido pelo TTS
                    resultContainer.dataset.lastTipText = apiResult.text.replace(/\*\*/g, '').replace(/###/g, ''); 
                    recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
                } catch (error) {
                    resultContainer.innerHTML = AiResultBox("Erro na IA", `Não foi possível gerar a dica: ${error.message}`);
                } finally {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            } 
            
            // --- Lógica para Botões de Exercício (Detalhes) ---
            else if (name) {
                // Exercise Specific Logic (Explanation, Variation, Form)
                const type = action;
                const exerciseName = name; 
                
                button.innerHTML = LoadingIndicator();
                button.disabled = true;

                const resultId = `result-${exerciseName.replace(/[^a-zA-Z0-9]/g, '-')}-${type}`;
                let resultContainer = document.getElementById(resultId);

                let systemPrompt = "Você é um personal trainer focado em técnica e segurança. Responda de forma concisa e em Português.";
                let userQuery = "";
                let title = "";

                if (type === 'explanation') {
                    userQuery = `Explique o propósito e os principais músculos trabalhados no exercício: ${exerciseName}.`;
                    title = `${exerciseName} - Explicação`;
                } else if (type === 'variation') {
                    userQuery = `Sugira uma variação ou alternativa para o exercício: ${exerciseName}, considerando o objetivo de ${profile.age < 30 ? 'ganho de massa' : 'saúde articular'}.`;
                    title = `${exerciseName} - Sugestão de Variação`;
                } else if (type === 'form') {
                    userQuery = `Descreva o passo a passo da forma correta de execução para o exercício: ${exerciseName}.`;
                    title = `${exerciseName} - Descrição da Forma`;
                }

                try {
                    const apiResult = await fetchWithRetry(userQuery, systemPrompt);
                    
                    if (!resultContainer) {
                        const card = button.closest('.exercise-card');
                        resultContainer = document.createElement('div');
                        resultContainer.id = resultId;
                        card.appendChild(resultContainer);
                    }
                    
                    resultContainer.innerHTML = AiResultBox(title, apiResult.text);
                    recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });

                } catch (error) {
                    if (!resultContainer) {
                        const card = button.closest('.exercise-card');
                        resultContainer = document.createElement('div');
                        resultContainer.id = resultId;
                        card.appendChild(resultContainer);
                    }
                    resultContainer.innerHTML = AiResultBox("Erro na IA", `Não foi possível processar: ${error.message}`);
                } finally {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
            
            // --- Lógica das Ferramentas da Página AI_TOOLS e NUTRITION ---
            else if (actionContainer) {
                let inputElement, resultContainer, handler;

                switch (action) {
                    case 'analyze-meal':
                        inputElement = actionContainer.querySelector('#mealDescription');
                        resultContainer = actionContainer.querySelector('#mealAnalyzerResult');
                        handler = handleMealAnalyze;
                        break;
                    case 'generate-recipe':
                        inputElement = actionContainer.querySelector('#ingredientsList');
                        resultContainer = actionContainer.querySelector('#recipeCreatorResult');
                        handler = handleGenerateRecipe;
                        break;
                    case 'quick-workout':
                        const timeSelect = actionContainer.querySelector('#quickWorkoutTime');
                        const equipmentSelect = actionContainer.querySelector('#quickWorkoutEquipment');
                        resultContainer = actionContainer.querySelector('#quickWorkoutResult');
                        handler = () => handleQuickWorkoutGenerate(button, timeSelect, equipmentSelect, resultContainer);
                        break;
                    case 'generate-mobility':
                        inputElement = actionContainer.querySelector('#mobilityFocus');
                        resultContainer = actionContainer.querySelector('#mobilityResult');
                        handler = () => handleMobilityGenerate(button, inputElement, resultContainer);
                        break;
                    case 'analyze-progress':
                        inputElement = actionContainer.querySelector('#progressNotes');
                        resultContainer = actionContainer.querySelector('#progressResult');
                        handler = handleAnalyzeProgress;
                        break;
                    case 'adjust-plan':
                        inputElement = actionContainer.querySelector('#planAdjustGoal');
                        resultContainer = actionContainer.querySelector('#planAdjustResult');
                        handler = () => handlePlanAdjust(button, inputElement, resultContainer);
                        break;
                    case 'plan-goal':
                        inputElement = actionContainer.querySelector('#weeklyGoal');
                        resultContainer = actionContainer.querySelector('#goalPlannerResult');
                        handler = handleGoalPlanner;
                        break;
                    default:
                        return;
                }

                // Executa o handler apropriado (diretamente ou com base nos inputs)
                if (handler) {
                    if (action === 'quick-workout' || action === 'generate-mobility' || action === 'adjust-plan' || action === 'plan-goal') {
                        handler();
                    } else if (inputElement) {
                        handler(button, inputElement, resultContainer);
                    } else {
                        console.error("Handler configuration error for action:", action);
                    }
                }
            }
        };

        document.addEventListener('click', handleDelegatedClick);
        
        // Funções de Handler (Nutrição/AI Tools) - Mantidas para funcionalidade

        const handleAnalyzeProgress = async (button, textarea, resultContainer) => {
            const notes = textarea.value.trim();
            if (!notes) return;
            
            button.innerHTML = LoadingIndicator('Avaliando seu esforço...');
            button.disabled = true;
            resultContainer.innerHTML = '';

            const systemPrompt = `Você é um mentor de fitness motivacional e analítico. Sua tarefa é analisar o diário de progresso semanal de um usuário e fornecer: 1) Um resumo conciso do progresso e dos desafios, e 2) Uma mensagem de motivação personalizada. A resposta deve ser estritamente em Português e formatada em Markdown. O usuário é: ${profile.name || 'Usuário Sem Nome'}, ${profile.age || 'idade desconhecida'}, ${profile.gender || 'sexo desconhecido'}.`;
            const userQuery = `Analise este diário de progresso semanal:\n\n"${notes}"`;

            try {
                const apiResult = await fetchWithRetry(userQuery, systemPrompt);
                resultContainer.innerHTML = AiResultBox("Análise de Progresso IA", apiResult.text);
                recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
            } catch (error) {
                resultContainer.innerHTML = AiResultBox("Erro na IA", `Erro ao analisar progresso: ${error.message}`);
            } finally {
                button.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Analisar Progresso com IA';
                button.disabled = false;
            }
        };

        const handleGenerateRecipe = async (button, textarea, resultContainer) => {
            const ingredients = textarea.value.trim();
            if (!ingredients) return;
            
            button.innerHTML = LoadingIndicator('Buscando a receita ideal...');
            button.disabled = true;
            resultContainer.innerHTML = '';

            const RECIPE_SCHEMA = {
                type: "OBJECT",
                properties: {
                    titulo: { type: "STRING" },
                    ingredientes: { type: "ARRAY", items: { type: "STRING" } },
                    instrucoes: { type: "ARRAY", items: { type: "STRING" } },
                    macros: { type: "STRING" }
                },
                required: ["titulo", "ingredientes", "instrucoes", "macros"]
            };

            const systemPrompt = `Você é um chef e nutricionista fitness. Sua tarefa é criar uma receita saudável e de fácil preparo usando os ingredientes fornecidos. A resposta DEVE seguir estritamente o esquema JSON fornecido, em Português. O usuário tem como foco um plano de treino para ${profile.gender === 'Feminino' ? 'mulheres' : 'homens'} e busca ${profile.age < 30 ? 'ganho de massa muscular' : 'manutenção de peso e saúde'}.`;
            const userQuery = `Crie uma receita fitness usando estes ingredientes: ${ingredients}.`;

            try {
                const apiResult = await fetchWithRetry(userQuery, systemPrompt, RECIPE_SCHEMA);
                const json = apiResult.json;
                
                let content = `<p class="text-indigo-400 font-semibold mb-2">Macros Estimados: ${json.macros || 'N/A'}</p>`;
                content += `<h4 class="text-lg font-bold text-indigo-400 mt-4">Ingredientes:</h4><ul class="list-disc list-inside ml-2">`;
                json.ingredientes?.forEach(ing => content += `<li>${ing}</li>`);
                content += `</ul>`;
                content += `<h4 class="text-lg font-bold text-indigo-400 mt-4">Instruções:</h4><ol class="list-decimal list-inside ml-2 space-y-1">`;
                json.instrucoes?.forEach(inst => content += `<li>${inst}</li>`);
                content += `</ol>`;

                resultContainer.innerHTML = AiResultBox(json.titulo || "Sua Nova Receita Fitness", content);
                recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
            } catch (error) {
                resultContainer.innerHTML = AiResultBox("Erro na IA", `Falha ao gerar a receita: ${error.message}`);
            } finally {
                button.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Criar Receita Saudável';
                button.disabled = false;
            }
        };
        
        const handleMealAnalyze = async (button, textarea, resultContainer) => {
            const mealDescription = textarea.value.trim();
            if (!mealDescription) return;

            button.innerHTML = LoadingIndicator('Calculando nutrição...');
            button.disabled = true;
            resultContainer.innerHTML = '';

            const systemPrompt = `Você é um analista de nutrição. Sua tarefa é estimar calorias, proteínas, carboidratos e gorduras (macros) de uma refeição descrita. Forneça o resultado de forma clara, estritamente em Português e em Markdown. Comece com "Estimativa Nutricional:".`;
            const userQuery = `Analise a seguinte refeição: "${mealDescription}".`;

            try {
                const apiResult = await fetchWithRetry(userQuery, systemPrompt);
                resultContainer.innerHTML = AiResultBox("Análise Nutricional IA", apiResult.text);
                recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
            } catch (error) {
                resultContainer.innerHTML = AiResultBox("Erro na IA", `Erro ao analisar a refeição: ${error.message}`);
            } finally {
                button.innerHTML = '<i data-lucide="zap" class="w-5 h-5 mr-2"></i> Analisar Refeição';
                button.disabled = false;
            }
        };
        
        const handleQuickWorkoutGenerate = async (button, timeSelect, equipmentSelect, resultContainer) => {
            const time = timeSelect.value;
            const equipment = equipmentSelect.value;
            
            button.innerHTML = LoadingIndicator('Criando seu circuito...');
            button.disabled = true;
            resultContainer.innerHTML = '';

            const systemPrompt = `Você é um personal trainer especialista em treinos rápidos (circuitos). Crie um treino eficaz para o usuário em Português. O treino deve ser formatado em uma lista concisa em Markdown. O foco é ${profile.age < 30 ? 'ganho de massa e alta intensidade' : 'manutenção e baixo impacto nas articulações'}.`;
            const userQuery = `Crie um treino rápido de ${time}, usando ${equipment}. O treino deve incluir aquecimento e desaquecimento.`;

            try {
                const apiResult = await fetchWithRetry(userQuery, systemPrompt);
                resultContainer.innerHTML = AiResultBox(`Seu Treino Expresso de ${time}`, apiResult.text);
                recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
            } catch (error) {
                resultContainer.innerHTML = AiResultBox("Erro na IA", `Erro ao gerar treino: ${error.message}`);
            } finally {
                button.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Gerar Treino Expresso';
                button.disabled = false;
            }
        };

        const handleMobilityGenerate = async (button, focusSelect, resultContainer) => {
            const focusArea = focusSelect.value;
            
            button.innerHTML = LoadingIndicator('Montando a sequência...');
            button.disabled = true;
            resultContainer.innerHTML = '';

            const systemPrompt = `Você é um especialista em mobilidade e prevenção de lesões. Crie uma rotina de 5-10 minutos, focada na área selecionada. A rotina deve ser descrita em Português com instruções claras e formatada em uma lista em Markdown.`;
            const userQuery = `Crie uma rotina de mobilidade focada em: ${focusArea}.`;

            try {
                const apiResult = await fetchWithRetry(userQuery, systemPrompt);
                resultContainer.innerHTML = AiResultBox(`Rotina para ${focusArea}`, apiResult.text);
                recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
            } catch (error) {
                resultContainer.innerHTML = AiResultBox("Erro na IA", `Erro ao gerar rotina: ${error.message}`);
            } finally {
                button.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Gerar Rotina de Mobilidade';
                button.disabled = false;
            }
        };

        const handleGoalPlanner = async (button, textarea, resultContainer) => {
            const goal = textarea.value.trim();
            if (!goal) return;

            button.innerHTML = LoadingIndicator('Criando seu plano de ação...');
            button.disabled = true;
            resultContainer.innerHTML = '';

            const systemPrompt = `Você é um coach de metas de fitness. Sua tarefa é pegar um objetivo geral e transformá-lo em um plano de ação semanal, com 3 a 5 passos SMART (Específicos, Mensuráveis, Alcançáveis, Relevantes, Temporais). Responda estritamente em Português e em Markdown. O usuário é: ${profile.name || 'Usuário Sem Nome'}.`;
            const userQuery = `Meu objetivo para a semana é: "${goal}". Crie um plano de ação SMART.`;

            try {
                const apiResult = await fetchWithRetry(userQuery, systemPrompt);
                resultContainer.innerHTML = AiResultBox(`Plano de Ação Semanal para "${goal}"`, apiResult.text);
                recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
            } catch (error) {
                resultContainer.innerHTML = AiResultBox("Erro na IA", `Erro ao planejar metas: ${error.message}`);
            } finally {
                button.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Planejar Minha Semana';
                button.disabled = false;
            }
        };

        const handlePlanAdjust = async (button, select, resultContainer) => {
            const newGoal = select.value;
            if (!newGoal) return;

            button.innerHTML = LoadingIndicator('Analisando plano...');
            button.disabled = true;
            resultContainer.innerHTML = '';

            const split = `Dia 1: Superior (Supino, Remada, Desenvolvimento de Ombros, Puxada); Dia 3: Inferior (Agachamento, Terra Romeno, Elevação Pélvica, Leg Press). Dia 2 é Cardio.`;

            const systemPrompt = `Você é um especialista em periodização de treino. O plano atual do usuário é: "${split}". Ele(a) é ${profile.gender || 'um atleta'} de ${profile.age || 'idade desconhecida'}. Sua tarefa é sugerir 3 modificações chave (mudanças de exercício, séries/repetições ou frequência) para alinhar o plano ao novo objetivo, mantendo a estrutura de 3 dias. Responda estritamente em Português e em Markdown.`;
            const userQuery = `O novo objetivo do usuário é: "${newGoal}". Sugira 3 modificações de alto impacto para o plano de treino.`;

            try {
                const apiResult = await fetchWithRetry(userQuery, systemPrompt);
                resultContainer.innerHTML = AiResultBox(`Sugestões de Ajuste para: ${newGoal}`, apiResult.text);
                recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
            } catch (error) {
                resultContainer.innerHTML = AiResultBox("Erro na IA", `Erro ao ajustar o plano: ${error.message}`);
            } finally {
                button.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Gerar Sugestão de Ajuste';
                button.disabled = false;
            }
        };


        const renderNutritionPage = () => {
            const cardBgClass = getThemeColorClass('card-bg');
            const inputBgClass = getThemeColorClass('input-bg');
            const textSecondary = getThemeColorClass('text-secondary');

            const mealAnalyzerHtml = `
                <div class="p-6 ${cardBgClass} rounded-xl shadow-2xl space-y-4">
                    <h2 class="text-2xl font-extrabold text-indigo-400 flex items-center">
                        <i data-lucide="utensils" class="w-6 h-6 mr-2 text-indigo-400"></i>
                        Analisador de Refeição com IA
                    </h2>
                    <p class="${textSecondary}">Descreva uma refeição que você fez e a IA irá fornecer uma estimativa de calorias e macros.</p>
                    <textarea id="mealDescription" rows="4" placeholder="Ex: 150g de peito de frango grelhado, uma xícara de arroz integral e meia batata-doce cozida." class="w-full p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}"></textarea>
                    <button data-action="analyze-meal" id="btnMealAnalyze" class="w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 ai-button ai-delegated-button">
                        <i data-lucide="zap" class="w-5 h-5 mr-2"></i> Analisar Refeição
                    </button>
                    <div id="mealAnalyzerResult"></div>
                </div>
            `;

            const recipeCreatorHtml = `
                <div class="p-6 ${cardBgClass} rounded-xl shadow-2xl space-y-4">
                    <h2 class="text-2xl font-extrabold text-indigo-400 flex items-center">
                        <i data-lucide="utensils" class="w-6 h-6 mr-2 text-indigo-400"></i>
                        Criador de Receitas com IA
                    </h2>
                    <p class="${textSecondary}">Liste os ingredientes que tem em casa e a IA cria uma receita saudável para você!</p>
                    <textarea id="ingredientsList" rows="4" placeholder="Ex: Peito de frango, batata-doce, brócolis, azeite, alho." class="w-full p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}"></textarea>
                    <button data-action="generate-recipe" id="btnGenerateRecipe" class="w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 ai-button ai-delegated-button">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Criar Receita Saudável
                    </button>
                    <div id="recipeCreatorResult"></div>
                </div>
            `;
            
            return `
                <div class="space-y-10">
                    <h1 class="text-4xl font-extrabold text-indigo-500 border-b border-indigo-500 pb-3">Plano de Nutrição & Ferramentas IA</h1>
                    ${mealAnalyzerHtml}
                    ${recipeCreatorHtml}
                    <div class="p-6 ${cardBgClass} rounded-xl shadow-2xl space-y-4">
                        <h2 class="text-2xl font-extrabold text-indigo-400">Plano de Nutrição Sugerido</h2>
                        <div class="space-y-4 ${textSecondary}">
                            <h4 class="text-xl font-bold text-indigo-400">Café da Manhã</h4>
                            <p>Aveia cozida com leite de amêndoes, banana e manteiga de amendoim.</p>
                            <h4 class="text-xl font-bold text-indigo-400">Almoço</h4>
                            <p>Peito de frango grelhado, quinoa e brócolis no vapor.</p>
                            <h4 class="text-xl font-bold text-indigo-400">Jantar</h4>
                            <p>Salmão grelhado com batata-doce assada e aspargos.</p>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderAiToolsPage = () => {
            const cardBgClass = getThemeColorClass('card-bg');
            const inputBgClass = getThemeColorClass('input-bg');
            const textSecondary = getThemeColorClass('text-secondary');
             
            const planAdjusterHtml = `
                <div class="p-6 ${cardBgClass} rounded-xl shadow-2xl space-y-4">
                    <h2 class="text-2xl font-extrabold text-indigo-400 flex items-center">
                        <i data-lucide="settings" class="w-6 h-6 mr-2 text-indigo-400"></i>
                        Ajuste seu Plano com IA
                    </h2>
                    <p class="${textSecondary}">Selecione um novo foco para a IA sugerir 3 modificações de alto impacto no seu treino.</p>
                    <label class="block">
                        <span class="text-sm font-medium ${textSecondary}">Meu novo objetivo:</span>
                        <select id="planAdjustGoal" class="mt-1 block w-full px-4 py-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}">
                            <option>Aumentar Força Máxima</option>
                            <option>Melhorar Resistência Muscular</option>
                            <option>Otimizar para Perda de Gordura</option>
                            <option>Foco em Glúteos e Posteriores</option>
                        </select>
                    </label>
                    <button data-action="adjust-plan" id="btnPlanAdjust" class="w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 ai-button ai-delegated-button">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Gerar Sugestão de Ajuste
                    </button>
                    <div id="planAdjustResult"></div>
                </div>
            `;

            const goalPlannerHtml = `
                <div class="p-6 ${cardBgClass} rounded-xl shadow-2xl space-y-4">
                    <h2 class="text-2xl font-extrabold text-indigo-400 flex items-center">
                        <i data-lucide="target" class="w-6 h-6 mr-2 text-indigo-400"></i>
                        Planejador de Metas Semanal
                    </h2>
                    <p class="${textSecondary}">Defina sua intenção para a semana e deixe a IA te ajudar a criar um plano de ação SMART.</p>
                    <textarea id="weeklyGoal" rows="3" placeholder="Ex: Quero melhorar meu Agachamento em 5kg até o final da semana." class="w-full p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}"></textarea>
                    <button data-action="plan-goal" id="btnGoalPlanner" class="w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 ai-button ai-delegated-button">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Planejar Minha Semana
                    </button>
                    <div id="goalPlannerResult"></div>
                </div>
            `;

            const quickWorkoutHtml = `
                <div class="p-6 ${cardBgClass} rounded-xl shadow-2xl space-y-4">
                    <h2 class="text-2xl font-extrabold text-indigo-400 flex items-center">
                        <i data-lucide="clock" class="w-6 h-6 mr-2 text-indigo-400"></i>
                        Treino Rápido com IA
                    </h2>
                    <p class="${textSecondary}">Sem tempo? Gere um treino eficaz com base no seu equipamento e tempo disponível.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="text-sm font-medium ${textSecondary}">Tempo Disponível</span>
                            <select id="quickWorkoutTime" class="mt-1 block w-full px-4 py-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}">
                                <option>15 Minutos</option>
                                <option>20 Minutos</option>
                                <option>30 Minutos</option>
                            </select>
                        </label>
                        <label class="block">
                            <span class="text-sm font-medium ${textSecondary}">Equipamento Disponível</span>
                            <select id="quickWorkoutEquipment" class="mt-1 block w-full px-4 py-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}">
                                <option>Apenas Peso do Corpo</option>
                                <option>Halteres Leves</option>
                            <option>Elásticos de Resistência</option>
                            </select>
                        </label>
                    </div>
                    <button data-action="quick-workout" id="btnQuickWorkout" class="w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 ai-button ai-delegated-button">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Gerar Treino Expresso
                    </button>
                    <div id="quickWorkoutResult"></div>
                </div>
            `;

            const mobilityRoutineHtml = `
                <div class="p-6 ${cardBgClass} rounded-xl shadow-2xl space-y-4">
                    <h2 class="text-2xl font-extrabold text-indigo-400 flex items-center">
                        <i data-lucide="move" class="w-6 h-6 mr-2 text-indigo-400"></i>
                        Sua Rotina de Mobilidade com IA
                    </h2>
                    <p class="${textSecondary}">Gere uma rotina rápida para prevenção de lesões e melhoria da flexibilidade.</p>
                    <label class="block">
                        <span class="text-sm font-medium ${textSecondary}">Qual área você quer focar hoje?</span>
                        <select id="mobilityFocus" class="mt-1 block w-full px-4 py-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}">
                            <option>Ombros e Pescoço</option>
                            <option>Coluna Torácica</option>
                            <option selected>Quadril e Lombar</option>
                            <option>Joelhos e Tornozelos</option>
                        </select>
                    </label>
                    <button data-action="generate-mobility" id="btnMobilityGenerate" class="w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 ai-button ai-delegated-button">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Gerar Rotina de Mobilidade
                    </button>
                    <div id="mobilityResult"></div>
                </div>
            `;

            const progressDiaryHtml = `
                <div class="p-6 ${cardBgClass} rounded-xl shadow-2xl space-y-4">
                    <h2 class="text-2xl font-extrabold text-indigo-400 flex items-center">
                        <i data-lucide="book-open" class="w-6 h-6 mr-2 text-indigo-400"></i>
                        Diário de Progresso Semanal
                    </h2>
                    <p class="${textSecondary}">Anote como foi sua semana de treinos. A IA irá resumir seu progresso e te dar motivação!</p>
                    <textarea id="progressNotes" rows="6" placeholder="Ex: Consegui levantar mais peso no Supino, mas senti dificuldade no agachamento. Minha dieta foi 80% limpa, mas falhei no sábado..." class="w-full p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}"></textarea>
                    <button data-action="analyze-progress" id="btnAnalyzeProgress" class="w-full py-3 px-4 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 ai-button ai-delegated-button">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i> Analisar Progresso com IA
                    </button>
                    <div id="progressResult"></div>
                </div>
            `;
            
            return `
                <div class="space-y-10">
                    <h1 class="text-4xl font-extrabold text-indigo-500 border-b border-indigo-500 pb-3">Outras Ferramentas IA Essenciais</h1>
                    ${planAdjusterHtml}
                    ${goalPlannerHtml}
                    ${quickWorkoutHtml}
                    ${mobilityRoutineHtml}
                    ${progressDiaryHtml}
                </div>
            `;
        };
        
        let chatMessages = [];

        const handleChatSend = async (inputElement, sendButton, resultContainer) => {
            const input = inputElement.value.trim();
            if (!input) return;

            const userMessage = { role: 'user', content: input };
            chatMessages.push(userMessage);
            inputElement.value = '';
            sendButton.disabled = true;
            
            renderChatMessages(resultContainer);
            
            const loadingHtml = LoadingIndicator('Digitando...');
            const chatBox = resultContainer.closest('.flex-col').querySelector('.chat-messages');
            const loadingIndicatorEl = document.createElement('div');
            loadingIndicatorEl.innerHTML = `<div class="flex justify-start">${loadingHtml}</div>`;
            chatBox.appendChild(loadingIndicatorEl);
            chatBox.scrollTop = chatBox.scrollHeight;


            const systemPrompt = `Você é um assistente de fitness pessoal experiente (personal trainer e nutricionista). Mantenha as respostas concisas e úteis. O usuário se chama ${profile.name || 'Usuário'}, tem ${profile.age || 'idade desconhecida'} e é do sexo ${profile.gender || 'desconhecido'}. Use o contexto do usuário sempre que possível.`;
            // Converte o histórico para o formato de query simples (para o modelo tratar como contexto)
            const userQuery = chatMessages.map(m => `${m.role === 'user' ? 'Usuário' : 'Assistente'}: ${m.content}`).join('\n');

            try {
                const apiResult = await fetchWithRetry(userQuery, systemPrompt);
                const aiResponse = { role: 'assistant', content: apiResult.text };
                chatMessages.push(aiResponse);
            } catch (error) {
                const errorMessage = { role: 'assistant', content: `Desculpe, houve um erro na comunicação com a IA: ${error.message}` };
                chatMessages.push(errorMessage);
            } finally {
                loadingIndicatorEl.remove();
                sendButton.disabled = false;
                renderChatMessages(resultContainer);
            }
        };

        const renderChatMessages = (container) => {
            const chatBox = container.closest('.flex-col').querySelector('.chat-messages');
            const cardBgClass = getThemeColorClass('card-bg');
            const textSecondary = getThemeColorClass('text-secondary');
            
            chatBox.innerHTML = chatMessages.map((msg, index) => {
                const isUser = msg.role === 'user';
                return `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-md ${
                            isUser 
                                ? 'bg-indigo-600 text-white rounded-br-none' 
                                : `${currentTheme === 'dark' ? 'bg-gray-700' : 'bg-gray-200'} ${textSecondary} rounded-tl-none`
                        }">
                            ${msg.content}
                        </div>
                    </div>
                `;
            }).join('');
            
            if (chatMessages.length === 0) {
                 chatBox.innerHTML = `<div class="text-center p-8 ${cardBgClass} rounded-lg ${textSecondary}">
                    Olá ${profile.name || 'usuário'}! Pergunte sobre treino, nutrição ou bem-estar.
                </div>`;
            }

            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to bottom
        };

        const renderFaqPage = () => {
            const cardBgClass = getThemeColorClass('card-bg');
            const inputBgClass = getThemeColorClass('input-bg');

             // Limpa o histórico de chat ao entrar na página, se não for a primeira vez
            if (currentPage !== PAGES.FAQ) {
                 chatMessages = [];
            }
            
            setTimeout(() => {
                const inputElement = document.getElementById('chatInput');
                const sendButton = document.getElementById('btnChatSend');
                const chatContainer = document.getElementById('chatContainer');
                
                if (inputElement && sendButton && chatContainer) {
                    // Inicializa a renderização das mensagens
                    renderChatMessages(chatContainer);

                    // Adiciona o evento de clique para o botão de envio
                    sendButton.onclick = () => handleChatSend(inputElement, sendButton, chatContainer);

                    // Adiciona o evento de tecla Enter
                    inputElement.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleChatSend(inputElement, sendButton, chatContainer);
                        }
                    });
                }
            }, 0);


            return `
                <div class="space-y-10">
                    <h1 class="text-4xl font-extrabold text-indigo-500 border-b border-indigo-500 pb-3">Tire suas Dúvidas com a IA</h1>
                    <div id="chatContainer" class="flex flex-col h-[500px] p-6 ${cardBgClass} rounded-xl shadow-2xl">
                        <h2 class="text-2xl font-extrabold text-indigo-400 mb-4 flex items-center">
                            <i data-lucide="message-square" class="w-6 h-6 mr-2 text-indigo-400"></i>
                            Assistente de Fitness IA
                        </h2>
                        <div class="flex-grow overflow-y-auto space-y-4 pr-2 custom-scrollbar chat-messages">
                            <!-- Mensagens de chat aqui -->
                        </div>
                        <div class="mt-4 flex">
                            <input
                                id="chatInput"
                                type="text"
                                placeholder="Faça sua pergunta aqui..."
                                class="flex-grow p-3 rounded-l-lg focus:ring-indigo-500 focus:border-indigo-500 ${inputBgClass}"
                            />
                            <button
                                id="btnChatSend"
                                class="p-3 rounded-r-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-300 shadow-md"
                            >
                                <i data-lucide="zap" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };


        const renderContent = () => {
            const container = document.getElementById('contentContainer');
            // Aplica a classe de fundo principal para o container de conteúdo
            container.className = `lg:col-span-3 p-6 rounded-xl transition-colors duration-300 ${getThemeColorClass('main-bg')}`;
            
            // Se o app estiver bloqueado, garante que a página seja a Visão Geral
            if (!isAppUnlocked() && currentPage !== PAGES.OVERVIEW) {
                currentPage = PAGES.OVERVIEW;
            }
            
            container.innerHTML = renderPage(currentPage);
            
            // Re-binds profile form listener after rendering
            if (currentPage === PAGES.OVERVIEW) {
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    // Remove listener anterior para evitar duplicidade
                    profileForm.removeEventListener('submit', handleProfileSave);
                    profileForm.addEventListener('submit', handleProfileSave);
                }
            }
            
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                recreateLucideIcons({ attrs: { class: 'w-5 h-5' } });
                recreateLucideIcons({ attrs: { class: 'w-6 h-6' } });
                recreateLucideIcons({ attrs: { class: 'w-10 h-10' } });
            }
        };

        // --- 4. Inicialização da Aplicação (REESTRUTURADA PARA FIREBASE) ---

        const initializeAppLogic = () => {
             // Carrega e aplica o tema salvo antes de qualquer renderização
            const savedTheme = localStorage.getItem('app-theme') || 'dark';
            applyTheme(savedTheme);
            
            // Adiciona listener para o toggle de tema
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);


            if (!firebaseConfig.apiKey) {
                console.error("Configuração do Firebase ausente. Usando modo sem persistência.");
                // Permite que a aplicação continue a ser renderizada sem persistência de dados
                authReady = true;
                currentUserId = 'anon-no-firestore';
                document.getElementById('userIdDisplay').textContent = currentUserId;
                renderApp();
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. Autenticação e Carregamento do Usuário
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    document.getElementById('userIdDisplay').textContent = currentUserId;
                    
                    // 2. Carregar Perfil do Usuário (em tempo real)
                    const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/main`);
                    onSnapshot(profileDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            profile = docSnap.data();
                        } else {
                            profile = {}; 
                        }
                        
                        // Garante que o usuário veja a Visão Geral se acabou de salvar e desbloqueou
                        if (isAppUnlocked() && currentPage === 'overview') {
                            currentPage = 'overview'; // Mantém na overview para ver o resultado
                        }

                        authReady = true; // Marca como pronto após a primeira checagem de perfil
                        renderApp();

                    }, (error) => {
                        console.error("Erro ao escutar o perfil:", error);
                        authReady = true;
                        renderApp();
                    });
                } else {
                    // Tenta autenticar
                    try {
                        if (initialAuthToken) {
                            const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                            currentUserId = userCredential.user.uid;
                        } else {
                            const userCredential = await signInAnonymously(auth);
                            currentUserId = userCredential.user.uid;
                        }
                    } catch (error) {
                        console.error("Erro na autenticação:", error);
                        // Falha na autenticação, renderiza o app como anônimo sem ID do Firestore
                        authReady = true;
                        renderApp();
                    }
                }
            });
        };
        
        // Função de Renderização principal que só é chamada quando a autenticação é resolvida
        const renderApp = () => {
            if (!authReady) return; 

            document.getElementById('loadingApp')?.remove();
            renderNavigation();
            renderContent();
        };


        // Inicia a lógica da aplicação quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', initializeAppLogic);

    </script>
</body>
</html>
